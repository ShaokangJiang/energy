<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0" />
    <title>Starter Template - Materialize</title>

    <!-- CSS  -->
    <link href="css/icon.css" rel="stylesheet">
    <link href="css/materialize.css" type="text/css" rel="stylesheet" media="screen,projection" />
    <link href="css/style.css" type="text/css" rel="stylesheet" media="screen,projection" />
    <script src="https://unpkg.com/javascript-lp-solver/src/solver.js"></script>
    <script src="./js/papaparse.min.js"></script>
</head>

<body>
    <nav class="Maroon" role="navigation">
        <div class="nav-wrapper container"><a id="logo-container" href="#" class="brand-logo">Logo</a>
        </div>
    </nav>

    <br><br>


    <div class="row">
        <div class="col s0 m0 l1">
        </div>


        <div class="col s12 m12 l7">

            <div class="row">
                <div class="col s12">

                    <div class="card white z-depth-3">
                        <div class="card-content black-text">
                            <span class="card-title">Glance</span>
                            <p>Model goes here</p>
                        </div>
                    </div>


                </div>

                <div class="col s12">

                    <div class="card white z-depth-3">
                        <div class="card-content black-text">
                            <span class="card-title">Components</span>
                            <div class="row">
                                <div class="col s12 m6">
                                    <div class="card-panel blue">
                                        <span class="white-text">
                                            <h6>Wind</h6>
                                            <p>Status: <span id="wind_status"></span>
                                        </p>
                                        <p>
                                            Production: <span id="wind_production"></span> KW
                                        </p>
                                        <p>
                                            Current Wind: <span id="wind_Speed"></span>
                                        </p>
                                        </span>
                                    </div>
                                </div>
                                <div class="col s12 m6">
                                    <div class="card-panel blue">
                                        <span class="white-text">
                                            <h6>Light</h6>
                                            <p>Status: <span id="Light_status"></span>
                                        </p>
                                        <p>
                                            Production: <span id="Light_production"></span> KW
                                        </p>
                                        <p>
                                            Current Light: <span id="Light_Speed"></span>
                                        </p>
                                        </span>
                                    </div>
                                </div>
                                <div class="col s12 m6">
                                    <div class="card-panel blue">
                                        <span class="white-text">
                                            <h6>Wave</h6>
                                            <p>Status: <span id="wave_status"></span>
                                        </p>
                                        <p>
                                            Production: <span id="wave_production"></span> KW
                                        </p>
                                        <p>
                                            Current wave: <span id="wave_Speed"></span>
                                        </p>
                                        </span>
                                    </div>
                                </div>
                                <div class="col s12 m6">
                                    <div class="card-panel blue">
                                        <span class="white-text">
                                            <h6>Current</h6>
                                            <p>Status: <span id="current_status"></span>
                                        </p>
                                        <p>
                                            Production: <span id="current_production"></span> KW
                                        </p>
                                        <p>
                                            Current current: <span id="current_Speed"></span>
                                        </p>
                                        </span>
                                    </div>
                                </div>
                                <div class="col s12 m6">
                                    <div class="card-panel blue">
                                        <span class="white-text">
                                            <h6>Battery</h6>
                                            <p>Status: <span id="battery_status"></span>
                                        </p>
                                        <p>
                                            Remain: <span id="battery_remain"></span>%
                                        </p>
                                        <p>
                                            Current flow: <span id="battery_flow"></span> KWH
                                        </p>
                                        <p>
                                            Current Usage: <span id="battery_usage"></span>
                                        </p>
                                        </span>
                                    </div>
                                </div>
                            </div>


                        </div>
                    </div>


                </div>

                <div class="col s12">

                    <div class="card white z-depth-3">
                        <div class="card-content black-text">
                            <span class="card-title">Export</span>
                            <p>Export result to csv at here: </p>
                            <div class="card-action">
                                <a href="#">Export</a>
                                <a href="#">This is a link</a>
                            </div>
                        </div>
                    </div>


                </div>


            </div>

        </div>
        <script>
            //true:on false:off
            var wind = true;
            var light = true;
            var wave = true;
            var current = true;
        </script>

        <div class="col s12 m12 l3">
            <div class="card white z-depth-3">
                <div class="card-content black-text">
                    <span class="card-title">Control Panel</span>
                    <p>Adjust setting as you want.</p>
                </div>
                <div class="card-action">
                    <div class="row">
                        <p class="col s6">
                            <span class="right black-text">Wind Switcher
                            </span> </p>
                        <p class="switch col s6">
                            <label>
                          Off
                          <input type="checkbox" id="wind" checked onchange="onWindChange(this);">
                          <span class="lever"></span>
                          On
                        </label>
                        </p>

                        <p class="col s6">
                            <span class="right black-text">Light Switcher
                        </span> </p>
                        <p class="switch col s6">
                            <label>
                      Off
                      <input type="checkbox" id="light" checked onchange="onLightChange(this);">
                      <span class="lever"></span>
                      On
                    </label>
                        </p>

                        <p class="col s6">
                            <span class="right black-text">Wave Switcher
                    </span> </p>
                        <p class="switch col s6">
                            <label>
                  Off
                  <input type="checkbox" id="wave" checked onchange="onWaveChange(this);">
                  <span class="lever"></span>
                  On
                </label>
                        </p>

                        <p class="col s6">
                            <span class="right black-text">Current Switcher
                    </span> </p>
                        <p class="switch col s6">
                            <label>
                  Off
                  <input type="checkbox" id="current" checked onchange="onCurrentChange(this);">
                  <span class="lever"></span>
                  On
                </label>
                        </p>

                    </div>
                </div>
            </div>
        </div>


        <div class="col s0 m0 l1">
        </div>


    </div>

    <br><br>
    </div>


    <div class="fixed-action-btn">
        <a id="menu" class="btn-floating btn-large red">
            <i class="large material-icons">menu</i>
        </a>
        <ul>
            <li><a class="btn-floating yellow darken-1" onclick="change_status()" id="Global_switch"><i class="material-icons">play_arrow</i></a></li>

            <!--change to pause-->
            <li><a class="btn-floating blue"><i class="material-icons" onclick="add()">file_upload</i></a></li>
        </ul>
    </div>


    <!-- Tap Target Structure -->
    <div class="tap-target" data-target="menu">
        <div class="tap-target-content">
            <h5>Basic Setup</h5>
            <p>File button to choose simulation file(Stream from sensor in real case). Start or pause to do related work globally. </p>
        </div>
    </div>
    <div id="UserEdit"></div>


    <footer class="page-footer orange">
        <div class="container">
            <div class="row">
                <h5 class="white-text">Info</h5>
                <p class="grey-text text-lighten-4">efe</p>



            </div>
            <div class="footer-copyright">
                <div class="container">
                    Made by <a class="orange-text text-lighten-3" href="https://shaokang.ga">Shaokang Jiang</a> using <a class="orange-text text-lighten-3" href="http://materializecss.com">Materialize</a>
                </div>
            </div>
    </footer>


    <!--  Scripts-->
    <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
    <script src="js/materialize.js"></script>
    <script>
        M.AutoInit();
        var Model_Status = 0; //1:running 0:pause 2:terminate
        var file;

        function onWindChange(use) {
            if (Model_Status == 1) {
                wind = use.checked;
                if (wind) {
                    document.getElementById("wind_status").innerHTML = '<font color="green">On </font>';
                } else {
                    document.getElementById("wind_status").innerHTML = '<font color="red">Off </font>';
                }
            }
        }

        function onLightChange(use) {
            if (Model_Status == 1) {
                light = use.checked;
                if (light) {
                    document.getElementById("Light_status").innerHTML = '<font color="green">On </font>';
                } else {
                    document.getElementById("Light_status").innerHTML = '<font color="red">Off </font>';
                }
            }
        }

        function onWaveChange(use) {
            if (Model_Status == 1) {
                wave = use.checked;
                if (wave) {
                    document.getElementById("wave_status").innerHTML = '<font color="green">On </font>';
                } else {
                    document.getElementById("wave_status").innerHTML = '<font color="red">Off </font>';
                }
            }
        }

        function onCurrentChange(use) {
            if (Model_Status == 1) {
                current = use.checked;
                if (current) {
                    document.getElementById("current_status").innerHTML = '<font color="green">On </font>';
                } else {
                    document.getElementById("current_status").innerHTML = '<font color="red">Off </font>';
                }
            }
        }

        $(document).ready(function() {
            $('.fixed-action-btn').floatingActionButton();
            $('.tap-target').tapTarget('open');
        });

        // document.getElementById("Speed_text").innerText = window.localStorage.getItem("wind");
        var request = {
                QueryString: function(val) {
                    var uri = window.location.search;
                    var re = new RegExp("" + val + "=([^&?]*)", "ig");
                    return ((uri.match(re)) ? (uri.match(re)[0].substr(val.length + 1)) : null);
                }
            }
            // so, You can using request.QueryString(para), like this
            // file:///C:/Users/Shaokang%20Jiang/Desktop/Energy/energy/run.html?group1=1&wind=74&light=74&wave=74&current=74&battary=74&freq=741&User=44174&action=

        if (request.QueryString("wind") == null || request.QueryString("light") == null || request.QueryString("wave") == null || request.QueryString("current") == null ||
            request.QueryString("battary") == null) {
            alert("Invalid visit.");
            window.location.href = "index.html";
        }
        var wind_limit = parseInt(request.QueryString("wind"));
        var light_limit = parseInt(request.QueryString("light"));
        var wave_limit = parseInt(request.QueryString("wave"));
        var current_limit = parseInt(request.QueryString("current"));
        var battary_capacity = parseInt(request.QueryString("battary"));
        var freq = parseInt(request.QueryString("freq")) || 200;
        var User_Consumption = parseInt(request.QueryString("User")) || 2000;
        var battery_current = 0.7 * battery_capacity;



        function OpenDetial(id, width, height) {
            var _srcWidth = parseInt(window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth);
            var _srcHeight = parseInt(window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight);
            _width = parseInt(width) || _srcWidth;
            _height = parseInt(height) || _srcHeight;

            var cssWidth = width == undefined ? "100%" : _width;
            var cssHeight = height == undefined ? "100%" : _height;

            var left = (_srcWidth - _width) == 0 ? 0 : ((_srcWidth - _width) / 2);
            var top = (_srcHeight - _height) == 0 ? 0 : ((_srcHeight - _height) / 2);


            var _id = "#" + id;
            var detial =
                '<div id="panel"> <div class="card white z-depth-3"><div class="card-content black-text">  <div class="row">' +
                '<div class="file-field input-field col s12"> <div class="btn"><span>File</span><input id="history_data" name="history_data" type="file" onchange="loadFile(this)"></div><div class="file-path-wrapper"><input placeholder="Input Stream" id="Input_Stream" class="file-path validate" type="text"></div></div><p class="col s8" id="notice"><p><button  id="usethis" class="waves-effect waves-light btn col s3" disabled onclick="Start()">Use This</button>' +
                '</div></div></div></div>';
            $(_id).html(detial);
            $(_id).css({
                "display": "none",
                "position": "fixed",
                "bottom": "0px",
                "width": "100%",
                "top": "0px",
                "height": "100%",
                "background-color": "rgba(223, 236, 236, 0.36)"
            });
            $("#panel").css({
                "width": cssWidth,
                "height": cssHeight,
                "left": left,
                "top": top,
                "position": "fixed"
            });
            $(_id).slideDown();
        }

        var prevTime = 0;

        function runStep(data) {

            var userConsumption = data["User_Usage"] || User_Consumption;
            var time = results.data["Time"];
            var wind_produced = 0,
                light_produced = 0,
                wave_produced = 0,
                current_produced = 0;

            if (data["Wind_Speed"] > wind_limit) {
                document.getElementById("wind_Speed").innerText = data["Wind_Speed"];
                wind_produced = 2866 * data["Wind_Speed"] * data["Wind_Speed"] * data["Wind_Speed"];
                document.getElementById("wind_production").innerText = wind_produced;
            }

            if (data["Light_H"] > light_limit) {
                document.getElementById("Light_Speed").innerText = data["Light_H"];
                light_produced = 0.09 * data["Light_H"];
                document.getElementById("Light_production").innerText = light_produced;
            }

            if (data["Wave_Hight"] * data["Wave_Hight"] * data["Wave_Period"] > wave_limit) {
                document.getElementById("wave_Speed").innerText = "Height: " + data["Wave_Hight"] + "Period: " + data["Wave_Period"];
                wave_produced = 6.6 * data["Wave_Hight"] * data["Wave_Hight"] * data["Wave_Period"];
                document.getElementById("wave_production").innerText = wave_produced;
            }

            if (data["Current_Speed"] > current_limit) {
                document.getElementById("current_Speed").innerText = data["Current_Speed"];
                current_produced = 1254 * data["Current_Speed"] * data["Current_Speed"] * data["Current_Speed"];
                document.getElementById("current_production").innerText = current_produced;
            }

            document.getElementById("battery_usage").innerText = userConsumption;
            var pre_battery_current = battery_current;
            battery_current += (wind_produced + light_produced + wave_produced + current_produced) * (time - prevTime) / 3600 - userConsumption;
            if (battery_current > battery_capacity) battery_current = battery_capacity;
            document.getElementById("battery_flow").innerText = (battery_current - pre_battery_current).toFixed(2);
            document.getElementById("battery_remain").innerText = (battery_current * 100 / battery_capacity).toFixed(2);
            if (battery_current - pre_battery_current > 0) document.getElementById("battery_status").innerText = 'Charging';
            else if (battery_current < 0) {
                battery_current = 0;
                document.getElementById("battery_remain").innerText = (battery_current * 100 / battery_capacity).toFixed(2);
                document.getElementById("battery_status").innerText = 'Discharging, extra electricity required.';
            } else {
                document.getElementById("battery_status").innerText = 'Discharging';
            }
            //refresh locals
            prevTime = time;
        }
        /**
         * If user consumption data is empty, then it will use the
         * Data from the first line will be ignored. (No duration is impossible to calculate)
         * Simple model, assume related daata could be provided 
         **/
        function Start() {
            var firstLine = true;
            $("#UserEdit").slideUp();
            document.getElementById("Global_switch").innerHTML = '<i class = "material-icons" > pause </i>';
            Model_Status = 1;
            document.getElementById("battery_remain").innerText = (battery_current * 100 / battery_capacity).toFixed(2);


            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                dynamicTyping: true,
                step: function(results, parser) {
                    console.log("Row data:", results.data["Time"]);
                    if (firstLine) {
                        firstLine = false;
                        prevTime = results.data["Time"];
                    } else {
                        //analyze data at here
                        runStep(results.data);
                        parser.pause();
                        while (Model_Status == 0) {}
                        setTimeout(function() {
                            var delay = function() {
                                if (Model_Status == 1) {
                                    //do some things at here
                                    parser.resume();
                                } else {
                                    setTimeout(function() {
                                        delay();
                                    }, 200)
                                }
                            }
                            delay();
                        }, freq);
                    }
                },
                complete: function(results, parser) {
                    console.log("done");
                    Model_Status = 2;
                    change_status();
                }
            });
        }


        function loadFile(file1) {
            file = file1.files[0];
            if (file != null) {
                document.getElementById("notice").innerText = "Successfully loaded";
                document.getElementById("usethis").disabled = false;
            }
        }

        function add() {
            var url = "index.html";
            OpenDetial("UserEdit", 400, 200); //调用方法        
        }

        function change_status() {
            if (Model_Status == 0) {
                document.getElementById("Global_switch").innerHTML = '<i class = "material-icons" > pause </i>';
                Model_Status = 1;
            } else if (Model_Status == 1) {
                document.getElementById("Global_switch").innerHTML = '<i class = "material-icons" > play_arrow </i>';
                Model_Status = 0;
            } else {
                document.getElementById("Global_switch").innerHTML = '<i class = "material-icons" > stop </i>';
            }
        }
    </script>

</body>

</html>